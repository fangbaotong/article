<html><head><meta http-equiv='Content-Type' content='text/html; charset=UTF-8'><title>thinkphp 文件下载 文件下载php</title>
<style>
body{
	width:960px;
	margin:0 auto;
}
#title{
	text-align:center;
}
</style>
</head><body><div id='title'><h2>thinkphp 文件下载 文件下载php</h2></div><ol>
	<li>
		<p>
			THinkPHP1.5中文件的下载&nbsp;用到的系统类库文件是Http.class.php，位于ThinkPHP\Lib\ORG\Net目录下，类名Http，其中有静态方法&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			static&nbsp;function&nbsp;download&nbsp;($filename,&nbsp;$showname=”,$content=”,$expire=180);&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@param&nbsp;string&nbsp;$filename&nbsp;下载文件名(完整路径加文件的保存名字）&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			*&nbsp;@param&nbsp;string&nbsp;$showname&nbsp;下载显示的文件名（想要显示的名字或者从数据库中读出的原来带中文的名字）；&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			*&nbsp;@param&nbsp;string&nbsp;$content&nbsp;&nbsp;下载的内容（默认为空，此时下载的文件就是原文件）。&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			*&nbsp;@param&nbsp;integer&nbsp;$expire&nbsp;&nbsp;下载内容浏览器缓存时间&nbsp;，默认为空时为180秒。&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			*/&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			因为PHP保存文件名不支持中文，所以通常中文文件名保存到服务器上时换成成英文名或者生成随机名字。下载时可以利用此方法回复原文件名。&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			应用举例：下载时显示文件原名&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			/*&nbsp;假设数据库里文件信息存储表为file(id,truename,savenane,user,size).&nbsp;
		</p>
	</li>
	<li>
		<p>
			文件存在于网站项目目录下的uploads文件夹里，本网站项目名为bm,其绝对路径为：&nbsp;
		</p>
	</li>
	<li>
		<p>
			H:\AppServ\www\bm\uploads\(&nbsp;&nbsp;H:\AppServ\www\为文档根目录）&nbsp;
		</p>
	</li>
	<li>
		<p>
			此时该目录下有一文件123456789.doc,(savename),原文件名为“读后感.doc”，即truename,大小为2MB.&nbsp;
		</p>
	</li>
	<li>
		<p>
			那么要下载时服务器端得程序为：&nbsp;
		</p>
	</li>
	<li>
		<p>
			class&nbsp;FileAction&nbsp;extends&nbsp;Action{&nbsp;
		</p>
	</li>
	<li>
		<p>
			public&nbsp;function&nbsp;download(){&nbsp;
		</p>
	</li>
	<li>
		<p>
			$uploadpath=’H:\AppServ\www\bm\uploads\’;//设置文件上传路径，服务器上的绝对路径&nbsp;
		</p>
	</li>
	<li>
		<p>
			$id=$_GET['id'];//GET方式传到此方法中的参数id,即文件在数据库里的保存id.根据之查找文件信息。&nbsp;
		</p>
	</li>
	<li>
		<p>
			if($id==”)&nbsp;//如果id为空而出错时，程序跳转到项目的Index/index页面。或可做其他处理。&nbsp;
		</p>
	</li>
	<li>
		<p>
			{$this-&gt;redirect(‘index’,'Index’,”,APP_NAME,”,1);&nbsp;
		</p>
	</li>
	<li>
		<p>
			}&nbsp;
		</p>
	</li>
	<li>
		<p>
			$file=D(‘File’);//利用与表file对应的数据模型类FileModel来建立数据对象。&nbsp;
		</p>
	</li>
	<li>
		<p>
			$result=&nbsp;$file-&gt;find($id);//根据id查询到文件信息&nbsp;
		</p>
	</li>
	<li>
		<p>
			if($result==false)&nbsp;//如果查询不到文件信息而出错时，程序跳转到项目的Index/index页面。或可做其他处理&nbsp;
		</p>
	</li>
	<li>
		<p>
			{$this-&gt;redirect(‘index’,'Index’,”,APP_NAME,”,1);&nbsp;
		</p>
	</li>
	<li>
		<p>
			}&nbsp;
		</p>
	</li>
	<li>
		<p>
			$savename=$file-&gt;savename;//文件保存名&nbsp;
		</p>
	</li>
	<li>
		<p>
			$showname=$file-&gt;truename;//文件原名&nbsp;
		</p>
	</li>
	<li>
		<p>
			$filename=$uploadpath.$savename;//完整文件名（路径加名字）&nbsp;
		</p>
	</li>
	<li>
		<p>
			import(‘ORG.Net.Http’);&nbsp;
		</p>
	</li>
	<li>
		<p>
			Http::download($filename,$showname);&nbsp;
		</p>
	</li>
	<li>
		<p>
			}&nbsp;
		</p>
	</li>
	<li>
		<p>
			}&nbsp;
		</p>
	</li>
	<li>
		<p>
			然后在该文件下载的HTML模板里要下载该文件的地方加一个下载链接，调用File模块的download方法即可。记得传参数id&nbsp;.&nbsp;
		</p>
	</li>
	<li>
		<p>
			如本例中：&nbsp;
		</p>
	</li>
	<li>
		<p>
			&lt;table&gt;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&lt;tr&gt;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&lt;td&gt;读后感.doc&lt;/td&gt;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&lt;td&gt;sunmoon&lt;/td&gt;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&lt;td&gt;&lt;a&nbsp;href=’__APP__/File/download/id/{$id}’&gt;下载&lt;/a&gt;&lt;/td&gt;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&lt;!–&nbsp;
		</p>
	</li>
	<li>
		<p>
			其中{$id}是模板变量，代表要下载的文件在数据库中的保存id.&nbsp;
		</p>
	</li>
	<li>
		<p>
			–&gt;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&lt;/tr&gt;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&lt;/table&gt;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;
		</p>
	</li>
	<li>
		<p>
			注：IE浏览器的下载文件名编码只有gb2312才能显示，若是不然，要不就是文件名乱码，要不就是找不到文件而无法下载。针对此种情况，我对原来的download()方法进行了一些调整，经过测试发现IE、傲游、firefox均可正常下载。&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;/**&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----------------------------------------------------------&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;下载文件&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;可以指定下载显示的文件名，并自动发送相应的Header信息&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;如果指定了content参数，则下载该参数的内容&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----------------------------------------------------------&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@static&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@access&nbsp;public&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----------------------------------------------------------&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$filename&nbsp;下载文件名&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$showname&nbsp;下载显示的文件名&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$content&nbsp;&nbsp;下载的内容&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;integer&nbsp;$expire&nbsp;&nbsp;下载内容浏览器缓存时间&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----------------------------------------------------------&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;void&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----------------------------------------------------------&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;ThinkExecption&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----------------------------------------------------------&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;public&nbsp;function&nbsp;download&nbsp;($filename,&nbsp;$showname='',$content='',$expire=180)&nbsp;{&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;if(file_exists($filename)){&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;$length&nbsp;=&nbsp;filesize($filename);&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;}elseif(is_file(UPLOAD_PATH.$filename)){&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;$filename&nbsp;=&nbsp;UPLOAD_PATH.$filename;&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;$length&nbsp;=&nbsp;filesize($filename);&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;}elseif($content&nbsp;!=&nbsp;''){&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;$length&nbsp;=&nbsp;strlen($content);&nbsp;&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;}else&nbsp;{&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;throw_exception($filename.L('下载文件不存在！'));&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;}&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;if(empty($showname)){&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;$showname&nbsp;=&nbsp;$filename;&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;}&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;$showname&nbsp;=&nbsp;basename($showname);&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;if(empty($filename)){&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;$type&nbsp;=&nbsp;mime_content_type($filename);&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;}else{&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;$type&nbsp;=&nbsp;"application/octet-stream";&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;}&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;//发送Http&nbsp;Header信息&nbsp;开始下载&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;header("content-type:text/html;&nbsp;charset=utf-8");&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;header("Pragma:&nbsp;public");&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;header("Cache-control:&nbsp;max-age=".$expire);&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;//header('Cache-Control:&nbsp;no-store,&nbsp;no-cache,&nbsp;must-revalidate');&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;header("Expires:&nbsp;"&nbsp;.&nbsp;gmdate("D,&nbsp;d&nbsp;M&nbsp;Y&nbsp;H:i:s",time()+$expire)&nbsp;.&nbsp;"GMT");&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;header("Last-Modified:&nbsp;"&nbsp;.&nbsp;gmdate("D,&nbsp;d&nbsp;M&nbsp;Y&nbsp;H:i:s",time())&nbsp;.&nbsp;"GMT");&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;//下面一行就是改动的地方，即用iconv("UTF-8","GB2312//TRANSLIT",$showname)系统函数转换编码为gb2312&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;header("Content-Disposition:&nbsp;attachment;&nbsp;filename=".&nbsp;iconv("UTF-8","GB2312",$showname));&nbsp;header("Content-Length:&nbsp;".$length);&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;header("Content-type:&nbsp;".$type);&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;header('Content-Encoding:&nbsp;none');&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;header("Content-Transfer-Encoding:&nbsp;binary"&nbsp;);&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;if($content&nbsp;==&nbsp;''&nbsp;)&nbsp;{&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;readfile($filename);&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;}&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;else&nbsp;{&nbsp;echo($content);&nbsp;}&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;exit();&nbsp;&nbsp;&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			注：iconv为php系统函数库，但需要安装。若是服务器还没有这个模块安装，则需将iconv.dll下载下来后复制到windows/system32/下面，同时在php安装文件夹得ext文件夹里也复制一份。&nbsp;&nbsp;
		</p>
	</li>
	<li>
		<p>
			然后在php.ini文件中将extension=php_iconv.dll前的”;”去掉，没有的话就加上extension=php_iconv.dll。然后重启服务器即可。&nbsp;
		</p>
	</li>
</ol></body></html>